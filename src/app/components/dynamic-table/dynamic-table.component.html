<div class="table-toolbar">
  @if (config().globalFilter !== false) {
    <p-iconfield>
      <p-inputicon styleClass="pi pi-search" />
      <input
        pInputText
        type="text"
        placeholder="Search..."
        (input)="applyFilter($event)"
      />
    </p-iconfield>
  }
</div>

<p-table
  #dt
  [value]="loading() ? skeletonRows : displayData()"
  [paginator]="config().paginator !== false"
  [rows]="config().rows ?? 10"
  [rowsPerPageOptions]="[5, 10, 25, 50]"
  [globalFilterFields]="filterFields()"
  [tableStyle]="{ 'min-width': '50rem' }"
  [stripedRows]="true"
  [(selection)]="selectedRows"
  [dataKey]="'id'"
>
  <ng-template #header>
    <tr>
      @if (config().selectionEnabled) {
        <th style="width: 3rem">
          <p-tableHeaderCheckbox />
        </th>
      }
      @for (col of config().columns; track col.field) {
        <th [pSortableColumn]="col.field">
          {{ col.header }}
          <p-sortIcon [field]="col.field" />
          @if (col.filterable) {
            <p-columnFilter [field]="col.field" display="menu" [showMatchModes]="true" />
          }
        </th>
      }
      @if (config().actions?.length) {
        <th>Actions</th>
      }
    </tr>
    <!-- Per-column search row -->
    @if (hasSearchableColumns()) {
      <tr>
        @if (config().selectionEnabled) {
          <th></th>
        }
        @for (col of config().columns; track col.field) {
          <th>
            @if (col.searchable) {
              <input
                pInputText
                type="text"
                [placeholder]="'Search ' + col.header"
                [value]="columnSearchValues[col.field] || ''"
                (input)="applyColumnFilter($any($event.target).value, col.field)"
                style="width: 100%"
              />
            }
          </th>
        }
        @if (config().actions?.length) {
          <th></th>
        }
      </tr>
    }
  </ng-template>

  <ng-template #body let-row>
    @if (loading()) {
      <!-- Skeleton loading row -->
      <tr>
        @if (config().selectionEnabled) {
          <td><p-skeleton height="1.2rem" /></td>
        }
        @for (col of config().columns; track col.field) {
          <td><p-skeleton height="1.2rem" /></td>
        }
        @if (config().actions?.length) {
          <td><p-skeleton height="1.2rem" width="4rem" /></td>
        }
      </tr>
    } @else {
      <!-- Real data row -->
      <tr>
        @if (config().selectionEnabled) {
          <td>
            <p-tableCheckbox [value]="row" />
          </td>
        }
        @for (col of config().columns; track col.field) {
          <td>{{ row[col.field] }}</td>
        }
        @if (config().actions?.length) {
          <td class="action-cell">
            @for (action of config().actions; track action.icon) {
              <p-button
                [icon]="action.icon"
                [rounded]="true"
                [text]="true"
                [severity]="action.severity ?? 'secondary'"
                [pTooltip]="action.tooltip"
                (onClick)="action.callback(row)"
              />
            }
          </td>
        }
      </tr>
    }
  </ng-template>

  <ng-template #emptymessage>
    <tr>
      <td
        [attr.colspan]="
          config().columns.length +
          (config().actions?.length ? 1 : 0) +
          (config().selectionEnabled ? 1 : 0)
        "
      >
        No records found.
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Export button bottom-right -->
@if (config().exportEnabled) {
  <div class="export-bar">
    <p-button
      label="Export"
      icon="pi pi-download"
      severity="success"
      (onClick)="openExportDialog()"
    />
  </div>
}

<!-- Export dialog -->
<p-dialog
  header="Export Data"
  [(visible)]="exportDialogVisible"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '400px' }"
>
  <div class="export-dialog-content">
    <div class="export-section">
      <label class="export-label">Format</label>
      <p-selectbutton
        [options]="formatOptions"
        [ngModel]="exportFormat()"
        (ngModelChange)="exportFormat.set($event)"
        optionLabel="label"
        optionValue="value"
      />
    </div>

    <div class="export-section">
      <label class="export-label">Scope</label>
      <p-selectbutton
        [options]="scopeOptions"
        [ngModel]="exportScope()"
        (ngModelChange)="exportScope.set($event)"
        optionLabel="label"
        optionValue="value"
      />
    </div>

    <div class="export-actions">
      <p-button label="Export" icon="pi pi-download" (onClick)="executeExport()" />
    </div>
  </div>
</p-dialog>
